%
% Copyright (C) 2020 The LaTeX3 project
%

\documentclass{minimal}
\input{regression-test}
\RequirePackage[enable-debug]{expl3}
\ExplSyntaxOn
\debug_on:n { check-declarations , deprecation , log-functions }
\ExplSyntaxOff

\begin{document}

\START
\AUTHOR{Phelype Oleinik}
\ExplSyntaxOn

\quark_new:N \q__test_recursion_tail
\quark_new:N \q__test_recursion_stop

\TEST{New~private~quark~functions~(:n)}{
  \__kernel_quark_test_generate:Nn
    \__test_quark_if_recursion_tail_stop:n { __test }
  \cs_log:N \__test_quark_if_recursion_tail_stop:n
}

\TEST{New~private~quark~functions~(:nn)}{
  \__kernel_quark_test_generate:Nn
    \__test_quark_if_recursion_tail_stop_do:nn { __test }
  \cs_log:N \__test_quark_if_recursion_tail_stop_do:nn
}

\TEST{New~private~quark~functions~(:N)}{
  \__kernel_quark_test_generate:Nn
    \__test_quark_if_recursion_tail_stop:N { __test }
  \cs_log:N \__test_quark_if_recursion_tail_stop:N
}

\TEST{New~private~quark~functions~(:Nn)}{
  \__kernel_quark_test_generate:Nn
    \__test_quark_if_recursion_tail_stop_do:Nn { __test }
  \cs_log:N \__test_quark_if_recursion_tail_stop_do:Nn
}

\TEST{New~private~quark~functions~(:nN)}{
  \__kernel_quark_test_generate:Nn
    \__test_quark_if_recursion_tail_break:nN { __test }
  \cs_log:N \__test_quark_if_recursion_tail_break:nN
}

\TEST{New~private~quark~functions~(:NN)}{
  \__kernel_quark_test_generate:Nn
    \__test_quark_if_recursion_tail_break:NN { __test }
  \cs_log:N \__test_quark_if_recursion_tail_break:NN
}

\TEST{Auxiliaries~to~the~kernel~quark~functions}{
  \cs_log:N \__test_if_test_recursion_tail:w
  \cs_log:N \__test_use_none_delimit_by_q_test_recursion_stop:w
  \cs_log:N \__test_use_i_delimit_by_q_test_recursion_stop:nw
}

\TESTEXP{Inside~recursions~(expect~nothing)}{
  \__test_quark_if_recursion_tail_stop:n
    {\q__test_recursion_tail} \ERROR \q__test_recursion_stop
  \__test_quark_if_recursion_tail_stop:N
    \q__test_recursion_tail \ERROR \q__test_recursion_stop
}

\TESTEXP{Inside~recursions~(expect~`YESYESYESYES')}{
  \__test_quark_if_recursion_tail_stop_do:nn
    {\q__test_recursion_tail}\YES\q__test_recursion_stop
  \__test_quark_if_recursion_tail_stop_do:nn
    {\q__test_recursion_tail}\YES\NO\q__test_recursion_stop
  \__test_quark_if_recursion_tail_stop_do:Nn
    \q__test_recursion_tail\YES\q__test_recursion_stop
  \__test_quark_if_recursion_tail_stop_do:Nn
    \q__test_recursion_tail\YES\NO\q__test_recursion_stop
}

\TESTEXP{Recursion~edge~cases~(expect~nothing)}{
  \__test_quark_if_recursion_tail_stop:n {{{{a}}}}
  \__test_quark_if_recursion_tail_stop:n {{ab\iffalse}\fi}
  \__test_quark_if_recursion_tail_stop_do:nn {{{{a}}}}{ \ERROR }
  \__test_quark_if_recursion_tail_stop_do:nn {{ab\iffalse}\fi}{ \ERROR }
}

\TEST{Invalid~signatures~(expect~errors)}{
  \__kernel_quark_test_generate:Nn
    \__test_quark_if_recursion_tail_break:nnn { __test }
  \__kernel_quark_test_generate:Nn
    \__test_quark_if_recursion_tail_break { __test }
}

\END
